<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projet PFE</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='server.css') }}">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    .split-container {
      display: flex;
      height: 100%;
      width: 100%;
      background-color: #ccc; /* Set background color to grey */
    }
    .left-frame {
      display: flex;
      flex-direction: column;
      flex: 1; /* Set flex to 1 for one-third of the screen */
      height: 100%;
    }
    .menu-top, .menu-bottom {
      flex: 1;
    }
    .menu-top {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 5px solid #000; /* Change line color to black */
    }
    .menu-top input[type="file"] {
      display: none;
    }
    .menu-top button {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .menu-top button:hover {
      background-color: #0056b3;
    }
    .menu-bottom {
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 5px solid #000; /* Change line color to black */
    }
    .menu-bottom button {
      margin: 0 10px;
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .menu-bottom button:hover {
      background-color: #0056b3;
    }
    .right-frame {
      flex: 2; /* Set flex to 2 for two-thirds of the screen */
      border-left: 5px solid #000; /* Change line color to black */
      position: relative;
    }
    .left-frame iframe, .right-frame canvas {
      max-width: 100%;
      max-height: 100%;
    }
    .content-image {
      display: block;
      margin: auto;
      max-width: 100%;
      max-height: 100%;
    }
  </style>
</head>
<body>
  <div class="split-container">
    <div class="left-frame">
      <div class="menu-top">
        <input type="file" id="fileInput" accept="image/*" onchange="loadImage(event)">
        <button onclick="document.getElementById('fileInput').click()">Choose Picture</button>
      </div>
      <div class="menu-bottom">
        <button onclick="showContours()">Show Contours</button>
        <button onclick="selectContour()">Select Contour</button>
        <button onclick="drawContour()">Draw Contour</button>
      </div>
    </div>
    <div class="right-frame">
      <canvas id="canvas" class="content-image"></canvas>
    </div>
  </div>

  <script>
    let image;
    let contours = [];
    let selectedContour = [];
    let drawnContour = [];
    let scale = null;

    function loadImage(event) {
      let canvas = document.getElementById('canvas');
      let ctx = canvas.getContext('2d');
      let img = new Image();
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0); // Draw the image first
        image = img;
      }
      img.src = URL.createObjectURL(event.target.files[0]);
    }

    function showContours() {
      let canvas = document.getElementById('canvas');
      let ctx = canvas.getContext('2d');

      // Convert image to grayscale
      let gray = cv.cvtColor(imageDataToMat(ctx.getImageData(0, 0, canvas.width, canvas.height)), cv.COLOR_RGBA2GRAY);

      // Find contours
      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      // Draw contours
      ctx.strokeStyle = 'green';
      ctx.lineWidth = 2;
      for (let i = 0; i < contours.size(); ++i) {
        let contour = contours.get(i);
        ctx.beginPath();
        for (let j = 0; j < contour.size(); ++j) {
          let point = contour.get(j);
          ctx.lineTo(point.x, point.y);
        }
        ctx.closePath();
        ctx.stroke();
        contour.delete();
      }

      // Delete Mats to free memory
      gray.delete();
      contours.delete();
      hierarchy.delete();

      // Enable select contour and draw contour buttons
      document.getElementById('selectContourButton').disabled = false;
      document.getElementById('drawContourButton').disabled = false;
    }

    function selectContour() {
      alert("Select a contour by clicking on it.");
      document.getElementById('canvas').addEventListener('click', onContourClick);
    }

    function onContourClick(event) {
      let x = event.offsetX;
      let y = event.offsetY;
      let canvas = document.getElementById('canvas');

      // Get image data
      let ctx = canvas.getContext('2d');
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      // Convert image data to Mat
      let mat = imageDataToMat(imageData);
      
      // Convert selected contour to Mat
      let contourMat = new cv.Mat();
      let contour = [];
      contour.push(new cv.Point(x, y));
      let cvContour = new cv.MatVector();
      cvContour.push_back(contour);
      cv.drawContours(mat, cvContour, -1, new cv.Scalar(0, 0, 255, 255), 2);
      
      // Display updated image
      ctx.putImageData(matToImageData(mat), 0, 0);

      // Delete Mats to free memory
      mat.delete();
      contourMat.delete();

      // Remove click event listener
      canvas.removeEventListener('click', onContourClick);
    }

    function drawContour() {
      alert("Draw a contour by clicking on the canvas.");
      document.getElementById('canvas').addEventListener('click', onCanvasClick);
    }

    function onCanvasClick(event) {
      let x = event.offsetX;
      let y = event.offsetY;
      let canvas = document.getElementById('canvas');
      let ctx = canvas.getContext('2d');
      
      // Draw the point
      ctx.beginPath();
      ctx.arc(x, y, 2, 0, 2 * Math.PI);
      ctx.fillStyle = 'red';
      ctx.fill();
      
      // Store the point
      drawnContour.push([x, y]);
    }

    // Function to convert ImageData to Mat
    function imageDataToMat(imageData) {
      let mat = cv.matFromArray(imageData.height, imageData.width, cv.CV_8UC4, imageData.data);
      let dst = new cv.Mat();
      cv.cvtColor(mat, dst, cv.COLOR_RGBA2GRAY);
      return dst;
    }

    // Function to convert Mat to ImageData
    function matToImageData(mat) {
      let canvas = document.createElement('canvas');
      cv.imshow(canvas, mat);
      return canvas.getContext('2d').getImageData(0, 0, mat.cols, mat.rows);
    }

    // Load OpenCV
    const script = document.createElement('script');
    script.src = 'https://docs.opencv.org/4.5.5/opencv.js';
    script.onload = () => {
      cv['onRuntimeInitialized'] = () => {
        console.log('OpenCV.js is ready');
      }
    };
    document.body.appendChild(script);
  </script>
</body>
</html>
